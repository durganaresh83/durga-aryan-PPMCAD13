input {
  beats {
    port => 5044
    type => "nginx"
  }
}

filter {
  if [fields][log_type] == "nginx" or [type] == "nginx" {
    
    # Parse Nginx access logs
    if [log][file][path] =~ "access" {
      grok {
        match => { 
          "message" => '%{IPORHOST:remote_addr} - %{DATA:remote_user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{DATA:request} HTTP/%{NUMBER:http_version}" %{NUMBER:status} %{NUMBER:body_bytes_sent} "%{DATA:http_referer}" "%{DATA:http_user_agent}"'
        }
        add_field => { "log_type" => "nginx_access" }
      }
      
      # Convert fields to proper types
      mutate {
        convert => {
          "status" => "integer"
          "body_bytes_sent" => "integer"
        }
      }
      
      # Parse timestamp
      date {
        match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        target => "@timestamp"
      }
      
      # Add geographic location from IP
      geoip {
        source => "remote_addr"
        target => "geoip"
      }
      
      # Parse user agent
      useragent {
        source => "http_user_agent"
        target => "user_agent"
      }
    }
    
    # Parse Nginx error logs
    if [log][file][path] =~ "error" {
      grok {
        match => {
          "message" => '(?<timestamp>%{YEAR}[./-]%{MONTHNUM}[./-]%{MONTHDAY}[- ]%{TIME}) \[%{LOGLEVEL:severity}\] %{POSINT:pid}#%{NUMBER:tid}: \*%{NUMBER:cid} %{GREEDYDATA:errormessage}'
        }
        add_field => { "log_type" => "nginx_error" }
      }
      
      date {
        match => [ "timestamp", "yyyy/MM/dd HH:mm:ss" ]
        target => "@timestamp"
      }
    }
  }
}

output {
  if [fields][log_type] == "nginx" or [type] == "nginx" {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      user => "elastic"
      password => "YOUR_ELASTIC_PASSWORD" # Replace `YOUR_ELASTIC_PASSWORD`** with your actual password!
      ssl_verification_mode => "none"
      index => "nginx-logs-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (optional)
  stdout {
    codec => rubydebug
  }
}